<div *ngIf="!varCoding" class="fx-flex-fill">
  &nbsp;
</div>
<div *ngIf="varCoding" class="fx-column-space-between-stretch" [style.padding]="'10px'">
  <div class="fx-row-start-stretch fx-gap-10">
    <div class="fx-column-start-stretch" [style.width.%]="30">
      <mat-form-field>
        <mat-label>{{'description-position' | translate}}</mat-label>
        <input matInput [(ngModel)]="varCoding.label"
               (change)="lastChangeFrom$.next('label')">
      </mat-form-field>
      <div *ngIf="varCoding.sourceType !== 'BASE'" [style.margin]="'4px 0 4px 20px'" class="fx-column-start-stretch">
        <mat-form-field>
          <mat-label>{{'derive-method.prompt' | translate}}</mat-label>
          <mat-select [(value)]="varCoding.sourceType" (selectionChange)="lastChangeFrom$.next('derive-method')">
            <mat-option [value]="'COPY_FIRST_VALUE'">
              {{'derive-method.COPY_FIRST_VALUE' | translate}}
            </mat-option>
            <mat-option [value]="'CONCAT_CODE'">
              {{'derive-method.CONCAT_CODE' | translate}}
            </mat-option>
            <mat-option [value]="'SUM_CODE'">
              {{'derive-method.SUM_CODE' | translate}}
            </mat-option>
            <mat-option [value]="'SUM_SCORE'">
              {{'derive-method.SUM_SCORE' | translate}}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <div class="fx-row-start-center fx-gap-5">
          <mat-label [class]="varCoding.deriveSources.length === 0 ? 'no-sources' : ''">{{ 'derive-sources.prompt' | translate }}</mat-label>
          <mat-chip-listbox>
            <mat-chip *ngIf="varCoding.deriveSources.length === 0" [matMenuTriggerFor]="menu">{{ 'derive-sources.error' | translate }}</mat-chip>
            <mat-chip *ngFor="let source of varCoding.deriveSources"
                      [class]="allVariables.indexOf(source) < 0 ? 'source-missing' : 'source-ok'"
                      removable="true" (removed)="deleteDeriveSource(source)">
              {{source}}
              <mat-icon matChipRemove>cancel</mat-icon>
            </mat-chip>
            <button mat-icon-button [matMenuTriggerFor]="menu" *ngIf="getNewSources(varCoding.deriveSources).length > 0">
              <mat-icon>add</mat-icon>
            </button>
          </mat-chip-listbox>
          <mat-menu #menu="matMenu">
            <button mat-menu-item *ngFor="let newSource of getNewSources(varCoding.deriveSources)" (click)="addDeriveSource(newSource)">
              {{newSource}}
            </button>
          </mat-menu>
        </div>
      </div>
      <div class="fx-row-start-center">
        <mat-form-field class="fx-flex-fill">
          <mat-label>{{ 'code-model.prompt' | translate }}</mat-label>
          <mat-select [(value)]="varCoding.codeModel">
            <mat-option [value]="'CHOICE'">
              {{'code-model.CHOICE' | translate}}
            </mat-option>
            <mat-option [value]="'VALUE_LIST'">
              {{'code-model.VALUE_LIST' | translate}}
            </mat-option>
            <mat-option [value]="'NUMBER'">
              {{'code-model.NUMBER' | translate}}
            </mat-option>
            <mat-option [value]="'MANUAL'">
              {{'code-model.MANUAL' | translate}}
            </mat-option>
            <mat-option [value]="'NONE'">
              {{'code-model.NONE' | translate}}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <button mat-icon-button (click)="smartSchemer()"
                [disabled]="varCoding.sourceType !== 'BASE'"
                [matTooltip]="'click.smart-schemer' | translate">
          <mat-icon>bolt</mat-icon>
        </button>
        <button mat-icon-button (click)="codingAsText()" [matTooltip]="'click.coding-as-text' | translate">
          <mat-icon>description</mat-icon>
        </button>
      </div>
    </div>
    <mat-card [style.flex]="'1 1 auto'">
      <mat-card-subtitle class="fx-row-space-between-stretch">
        {{'manual-instruction.prompt-general' | translate}}
        <button mat-icon-button (click)="editTextDialog_manualInstruction()">
          <mat-icon>edit</mat-icon>
        </button>
      </mat-card-subtitle>
      <mat-card-content class="instructions">
        <div [innerHTML]="varCoding ? getSanitizedText(varCoding.manualInstruction) : null"></div>
      </mat-card-content>
    </mat-card>
  </div>
  <ng-container [ngSwitch]="varCoding.codeModel">
    <var-codes-manual *ngSwitchCase="'MANUAL'"
                    class="fx-flex-row-100" [style.margin-top.px]="10"
                    [codes]="varCoding.codes"
                    (codesChanged)="lastChangeFrom$.next('var-codes-full codes')"
                    [processing]="varCoding.processing"
                    [fragmenting]="varCoding.fragmenting"
                    (fragmentingChanged)="setFragmenting($event)"
                    (processingChanged)="lastChangeFrom$.next('var-codes-full processing')"
                    [codeModelParameters]="varCoding.codeModelParameters"
                    (codeModelParametersChanged)="lastChangeFrom$.next('var-codes-full codeModelParameters')"
                    [allVariables]="allVariables">
    </var-codes-manual>
    <var-codes-value-list *ngSwitchCase="'VALUE_LIST'"
                      class="fx-flex-row-100" [style.margin-top.px]="10"
                      [codes]="varCoding.codes"
                      (codesChanged)="lastChangeFrom$.next('var-codes-full codes')"
                      [processing]="varCoding.processing"
                      (processingChanged)="lastChangeFrom$.next('var-codes-full processing')"
                      [fragmenting]="varCoding.fragmenting"
                      (fragmentingChanged)="setFragmenting($event)"
                      [codeModelParameters]="varCoding.codeModelParameters"
                      (codeModelParametersChanged)="lastChangeFrom$.next('var-codes-full codeModelParameters')"
                      [allVariables]="allVariables">
    </var-codes-value-list>
    <var-codes-choice *ngSwitchCase="'CHOICE'"
                          class="fx-flex-row-100" [style.margin-top.px]="10"
                          [codes]="varCoding.codes"
                          (codesChanged)="lastChangeFrom$.next('var-codes-full codes')"
                          [processing]="varCoding.processing"
                          (processingChanged)="lastChangeFrom$.next('var-codes-full processing')"
                          [fragmenting]="varCoding.fragmenting"
                          (fragmentingChanged)="setFragmenting($event)"
                          [codeModelParameters]="varCoding.codeModelParameters"
                          (codeModelParametersChanged)="lastChangeFrom$.next('var-codes-full codeModelParameters')"
                          [allVariables]="allVariables">
    </var-codes-choice>
    <var-codes-number *ngSwitchCase="'NUMBER'"
                          class="fx-flex-row-100" [style.margin-top.px]="10"
                          [codes]="varCoding.codes"
                          (codesChanged)="lastChangeFrom$.next('var-codes-full codes')"
                          [processing]="varCoding.processing"
                          (processingChanged)="lastChangeFrom$.next('var-codes-full processing')"
                          [fragmenting]="varCoding.fragmenting"
                          (fragmentingChanged)="setFragmenting($event)"
                          [codeModelParameters]="varCoding.codeModelParameters"
                          (codeModelParametersChanged)="lastChangeFrom$.next('var-codes-full codeModelParameters')"
                          [allVariables]="allVariables">
    </var-codes-number>
    <var-codes-full *ngSwitchDefault
                    class="fx-flex-row-100" [style.margin-top.px]="10"
                    [codes]="varCoding.codes"
                    (codesChanged)="lastChangeFrom$.next('var-codes-full codes')"
                    [processing]="varCoding.processing"
                    (processingChanged)="lastChangeFrom$.next('var-codes-full processing')"
                    [fragmenting]="varCoding.fragmenting"
                    (fragmentingChanged)="setFragmenting($event)"
                    [codeModelParameters]="varCoding.codeModelParameters"
                    (codeModelParametersChanged)="lastChangeFrom$.next('var-codes-full codeModelParameters')"
                    [allVariables]="allVariables">
    </var-codes-full>
  </ng-container>
</div>


